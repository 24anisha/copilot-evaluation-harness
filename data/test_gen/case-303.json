{
    "case_id": "case-303",
    "repo_name": "Rob--W/cors-anywhere",
    "file_path": "lib/cors-anywhere.js",
    "code_snippet": "// Request handler factory\n\nfunction getHandler(options, proxy) {\n\n  var corsAnywhere = {\n\n    handleInitialRequest: null,     // Function that may handle the request instead, by returning a truthy value.\n\n    getProxyForUrl: getProxyForUrl, // Function that specifies the proxy to use\n\n    maxRedirects: 5,                // Maximum number of redirects to be followed.\n\n    originBlacklist: [],            // Requests from these origins will be blocked.\n\n    originWhitelist: [],            // If non-empty, requests not from an origin in this list will be blocked.\n\n    checkRateLimit: null,           // Function that may enforce a rate-limit by returning a non-empty string.\n\n    redirectSameOrigin: false,      // Redirect the client to the requested URL for same-origin requests.\n\n    requireHeader: null,            // Require a header to be set?\n\n    removeHeaders: [],              // Strip these request headers.\n\n    setHeaders: {},                 // Set these request headers.\n\n    corsMaxAge: 0,                  // If set, an Access-Control-Max-Age header with this value (in seconds) will be added.\n\n    helpFile: __dirname + '/help.txt',\n\n  };\n\n\n\n  Object.keys(corsAnywhere).forEach(function(option) {\n\n    if (Object.prototype.hasOwnProperty.call(options, option)) {\n\n      corsAnywhere[option] = options[option];\n\n    }\n\n  });\n\n\n\n  // Convert corsAnywhere.requireHeader to an array of lowercase header names, or null.\n\n  if (corsAnywhere.requireHeader) {\n\n    if (typeof corsAnywhere.requireHeader === 'string') {\n\n      corsAnywhere.requireHeader = [corsAnywhere.requireHeader.toLowerCase()];\n\n    } else if (!Array.isArray(corsAnywhere.requireHeader) || corsAnywhere.requireHeader.length === 0) {\n\n      corsAnywhere.requireHeader = null;\n\n    } else {\n\n      corsAnywhere.requireHeader = corsAnywhere.requireHeader.map(function(headerName) {\n\n        return headerName.toLowerCase();\n\n      });\n\n    }\n\n  }\n\n  var hasRequiredHeaders = function(headers) {\n\n    return !corsAnywhere.requireHeader || corsAnywhere.requireHeader.some(function(headerName) {\n\n      return Object.hasOwnProperty.call(headers, headerName);\n\n    });\n\n  };\n\n\n\n  return function(req, res) {\n\n    req.corsAnywhereRequestState = {\n\n      getProxyForUrl: corsAnywhere.getProxyForUrl,\n\n      maxRedirects: corsAnywhere.maxRedirects,\n\n      corsMaxAge: corsAnywhere.corsMaxAge,\n\n    };\n\n\n\n    var cors_headers = withCORS({}, req);\n\n    if (req.method === 'OPTIONS') {\n\n      // Pre-flight request. Reply successfully:\n\n      res.writeHead(200, cors_headers);\n\n      res.end();\n\n      return;\n\n    }\n\n\n\n    var location = parseURL(req.url.slice(1));\n\n\n\n    if (corsAnywhere.handleInitialRequest && corsAnywhere.handleInitialRequest(req, res, location)) {\n\n      return;\n\n    }\n\n\n\n    if (!location) {\n\n      // Special case http:/notenoughslashes, because new users of the library frequently make the\n\n      // mistake of putting this application behind a server/router that normalizes the URL.\n\n      // See https://github.com/Rob--W/cors-anywhere/issues/238#issuecomment-629638853\n\n      if (/^\\/https?:\\/[^/]/i.test(req.url)) {\n\n        res.writeHead(400, 'Missing slash', cors_headers);\n\n        res.end('The URL is invalid: two slashes are needed after the http(s):.');\n\n        return;\n\n      }\n\n      // Invalid API call. Show how to correctly use the API\n\n      showUsage(corsAnywhere.helpFile, cors_headers, res);\n\n      return;\n\n    }\n\n\n\n    if (location.host === 'iscorsneeded') {\n\n      // Is CORS needed? This path is provided so that API consumers can test whether it's necessary\n\n      // to use CORS. The server's reply is always No, because if they can read it, then CORS headers\n\n      // are not necessary.\n\n      res.writeHead(200, {'Content-Type': 'text/plain'});\n\n      res.end('no');\n\n      return;\n\n    }\n\n\n\n    if (location.port > 65535) {\n\n      // Port is higher than 65535\n\n      res.writeHead(400, 'Invalid port', cors_headers);\n\n      res.end('Port number too large: ' + location.port);\n\n      return;\n\n    }\n\n\n\n    if (!/^\\/https?:/.test(req.url) && !isValidHostName(location.hostname)) {\n\n      // Don't even try to proxy invalid hosts (such as /favicon.ico, /robots.txt)\n\n      res.writeHead(404, 'Invalid host', cors_headers);\n\n      res.end('Invalid host: ' + location.hostname);\n\n      return;\n\n    }\n\n\n\n    if (!hasRequiredHeaders(req.headers)) {\n\n      res.writeHead(400, 'Header required', cors_headers);\n\n      res.end('Missing required request header. Must specify one of: ' + corsAnywhere.requireHeader);\n\n      return;\n\n    }\n\n\n\n    var origin = req.headers.origin || '';\n\n    if (corsAnywhere.originBlacklist.indexOf(origin) >= 0) {\n\n      res.writeHead(403, 'Forbidden', cors_headers);\n\n      res.end('The origin \"' + origin + '\" was blacklisted by the operator of this proxy.');\n\n      return;\n\n    }\n\n\n\n    if (corsAnywhere.originWhitelist.length && corsAnywhere.originWhitelist.indexOf(origin) === -1) {\n\n      res.writeHead(403, 'Forbidden', cors_headers);\n\n      res.end('The origin \"' + origin + '\" was not whitelisted by the operator of this proxy.');\n\n      return;\n\n    }\n\n\n\n    var rateLimitMessage = corsAnywhere.checkRateLimit && corsAnywhere.checkRateLimit(origin);\n\n    if (rateLimitMessage) {\n\n      res.writeHead(429, 'Too Many Requests', cors_headers);\n\n      res.end('The origin \"' + origin + '\" has sent too many requests.\\n' + rateLimitMessage);\n\n      return;\n\n    }\n\n\n\n    if (corsAnywhere.redirectSameOrigin && origin && location.href[origin.length] === '/' &&\n\n        location.href.lastIndexOf(origin, 0) === 0) {\n\n      // Send a permanent redirect to offload the server. Badly coded clients should not waste our resources.\n\n      cors_headers.vary = 'origin';\n\n      cors_headers['cache-control'] = 'private';\n\n      cors_headers.location = location.href;\n\n      res.writeHead(301, 'Please use a direct request', cors_headers);\n\n      res.end();\n\n      return;\n\n    }\n\n\n\n    var isRequestedOverHttps = req.connection.encrypted || /^\\s*https/.test(req.headers['x-forwarded-proto']);\n\n    var proxyBaseUrl = (isRequestedOverHttps ? 'https://' : 'http://') + req.headers.host;\n\n\n\n    corsAnywhere.removeHeaders.forEach(function(header) {\n\n      delete req.headers[header];\n\n    });\n\n\n\n    Object.keys(corsAnywhere.setHeaders).forEach(function(header) {\n\n      req.headers[header] = corsAnywhere.setHeaders[header];\n\n    });\n\n\n\n    req.corsAnywhereRequestState.location = location;\n\n    req.corsAnywhereRequestState.proxyBaseUrl = proxyBaseUrl;\n\n\n\n    proxyRequest(req, res, proxy);\n\n  };\n\n}\n",
    "line_range": [
        255,
        408
    ],
    "command_specific_fields": {
        "method_name": "getHandler"
    },
    "language": "javascript",
    "commit": "70aaa22b3f9ad30c8566024bf25484fd1ed9bda9",
    "prompt": ""
}