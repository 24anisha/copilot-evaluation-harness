{
    "case_id": "case-1137",
    "repo_name": "darknessomi/musicbox",
    "file_path": "NEMbox/ui.py",
    "code_snippet": "        self.screen.refresh()\n\n    def update_lyrics(self, now_playing, lyrics, tlyrics):\n\n        timestap_regex = r\"[0-5][0-9]:[0-5][0-9]\\.[0-9]*\"\n\n        def get_timestap(lyric_line):\n            match_ret = re.match(r\"\\[(\" + timestap_regex + r\")\\]\", lyric_line)\n            if match_ret:\n                return match_ret.group(1)\n            else:\n                return \"\"\n\n        def get_lyric_time(lyric_line):\n            lyric_timestap = get_timestap(lyric_line)\n            if lyric_timestap == \"\":\n                return datetime.timedelta(seconds=now_playing)\n            else:\n                return (\n                    datetime.datetime.strptime(get_timestap(lyric_line), \"%M:%S.%f\")\n                    - datetime.datetime.strptime(\"00:00\", \"%M:%S\")\n                    - lyric_time_offset\n                )\n\n        def strip_timestap(lyric_line):\n            return re.sub(r\"\\[\" + timestap_regex + r\"\\]\", r\"\", lyric_line)\n\n        def append_translation(translated_lyric, origin_lyric):\n            translated_lyric = strip_timestap(translated_lyric)\n            origin_lyric = strip_timestap(origin_lyric)\n            if translated_lyric == \"\" or origin_lyric == \"\":\n                return translated_lyric + origin_lyric\n            return translated_lyric + \" || \" + origin_lyric\n\n        if (\n            tlyrics and self.now_tlyric_index >= len(tlyrics) - 1\n        ) or self.now_lyric_index >= len(lyrics) - 1:\n            self.post_lyric = \"\"\n            return\n\n        lyric_time_offset = datetime.timedelta(seconds=0.5)\n        next_lyric_time = get_lyric_time(lyrics[self.now_lyric_index + 1])\n        # now_lyric_time = get_lyric_time(lyrics[self.now_lyric_index])\n        now_time = datetime.timedelta(seconds=now_playing)\n        while now_time >= next_lyric_time and self.now_lyric_index < len(lyrics) - 2:\n            self.now_lyric_index = self.now_lyric_index + 1\n            next_lyric_time = get_lyric_time(lyrics[self.now_lyric_index + 1])\n\n        if tlyrics:\n            next_tlyric_time = get_lyric_time(tlyrics[self.now_tlyric_index + 1])\n            while (\n                now_time >= next_tlyric_time\n                and self.now_tlyric_index < len(tlyrics) - 2\n            ):\n                self.now_tlyric_index = self.now_tlyric_index + 1\n                next_tlyric_time = get_lyric_time(tlyrics[self.now_tlyric_index + 1])\n\n        if tlyrics:\n            self.now_lyric = append_translation(\n                tlyrics[self.now_tlyric_index], lyrics[self.now_lyric_index]\n            )\n            if (\n                self.now_tlyric_index < len(tlyrics) - 1\n                and self.now_lyric_index < len(lyrics) - 1\n            ):\n                self.post_lyric = append_translation(\n                    tlyrics[self.now_tlyric_index + 1], lyrics[self.now_lyric_index + 1]\n                )\n            else:\n                self.post_lyric = \"\"\n        else:\n            self.now_lyric = strip_timestap(lyrics[self.now_lyric_index])\n            if self.now_lyric_index < len(lyrics) - 1:\n                self.post_lyric = strip_timestap(lyrics[self.now_lyric_index + 1])\n            else:\n                self.post_lyric = \"\"\n",
    "line_range": [
        187,
        262
    ],
    "command_specific_fields": {
        "method_name": "update_lyrics"
    },
    "language": "python",
    "commit": "592e13d1b948201447d008f4f3e249d347f47f21",
    "prompt": ""
}